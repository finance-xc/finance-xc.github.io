# MIFARE

`MIFARE` 是恩智浦半导体公司 NXP 拥有的一系列非接触式智能卡和邻近卡技术的注册商标。

::: tip
`MIFARE` 的名字由来是米克朗车资收费系统（ `MI`kron `FARE`-collection System）组合而来。
:::

## 简介

`MIFARE` 是遵循了 [ISO/IEC 14443-A](https://www.nxp.com/products/rfid-nfc/nfc-hf/nfc-readers/standard-performance-iso-iec-14443-a-b-frontend:MFRC52302HN1) 规范，利用无线射频（13.56MHz）识别技术的多种非接触式智能卡专有解决方案。这项技术是最早是 1994 年由米克朗集团（Mikron Group）开发，在 1998 年转售给飞利浦电子公司（ 2006 年拆分成为恩智浦半导体公司）。被广泛应用在公共交通支付系统（如公交卡）、商店小额消费系统（如积分卡）、门禁安全系统（如小区门禁卡和电梯卡）、电力收费、停车场 ETC、会员卡、借书证等。

## 卡片分类

  * MIFARE Classic
  * MIFARE DESFire
  * MIFARE Ultralight
  * MIFARE Plus

由于笔者目前在工作中只接触到了 MIFARE Classic 1k 卡片，所以以下内容都是围绕我手上的这张卡片来讲解和分析的。时间和能力有限，如有错误还望指正 🫶。

## 存储结构

MIFARE Classic 1k 卡，也就是我们常说的 M1 卡，这里 1k 的由来呢，就是指这种卡片内部有 1024 个字节的存储空间。其他的还有 MIFARE Classic 4k 卡片，也就是内部有 4096 个字节的存储空间。下面我们来看看 M1 卡的内部存储。

```json
  "blocks": {
    "0": "611AFB10900804006263646566676869",
    "1": "00000000000000000000000000000000",
    "2": "00000000000000000000000000000000",
    "3": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",

    "4": "0A000000F5FFFFFF0A00000000FF00FF",
    "5": "00000000000000000000000000000000",
    "6": "00000000000000000000000000000000",
    "7": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",

    "8": "0A000000F5FFFFFF0A00000000FF00FF",
    "9": "00000000000000000000000000000010",
    "10": "00000000000000000000000000000000",
    "11": "FFFFFFFFFFFF88778769FFFFFFFFFFFF",

    "16": "00000000000000000000000000000000",
    "17": "00000000000000000000000000000000",
    "18": "00000000000000000000000000000000",
    "19": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",

    "20": "00000000000000000000000000000000",
    "21": "00000000000000000000000000000000",
    "22": "00000000000000000000000000000000",
    "23": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",

    "24": "00000000000000000000000000000000",
    "25": "00000000000000000000000000000000",
    "26": "00000000000000000000000000000000",
    "27": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",

    "28": "00000000000000000000000000000000",
    "29": "00000000000000000000000000000000",
    "30": "00000000000000000000000000000000",
    "31": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",

    "32": "00000000000000000000000000000000",
    "33": "00000000000000000000000000000000",
    "34": "00000000000000000000000000000000",
    "35": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",

    "36": "00000000000000000000000000000000",
    "37": "00000000000000000000000000000000",
    "38": "00000000000000000000000000000000",
    "39": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",

    "40": "00000000000000000000000000000000",
    "41": "00000000000000000000000000000000",
    "42": "00000000000000000000000000000000",
    "43": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",

    "44": "00000000000000000000000000000000",
    "45": "00000000000000000000000000000000",
    "46": "00000000000000000000000000000000",
    "47": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",

    "48": "00000000000000000000000000000000",
    "49": "00000000000000000000000000000000",
    "50": "00000000000000000000000000000000",
    "51": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",

    "52": "00000000000000000000000000000000",
    "53": "00000000000000000000000000000000",
    "54": "00000000000000000000000000000000",
    "55": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",

    "56": "00000000000000000000000000000000",
    "57": "00000000000000000000000000000000",
    "58": "00000000000000000000000000000000",
    "59": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",

    "60": "00000000000000000000000000000000",
    "61": "00000000000000000000000000000000",
    "62": "00000000000000000000000000000000",
    "63": "FFFFFFFFFFFFFF0780BCFFFFFFFFFFFF"
  }
```
::: tip
从上面可以看出，总共有 64 个 block。一般我们会将其分为 [0-15] 16 个扇区，每个扇区有 4 个 block，刚好 16\*4\*16 = 1024 字节。这 4 个 block 0，1，2，3 都有其特定的用途和含义。 
:::

### 0 扇区
```json{2,5}
{
    "0": "611AFB10900804006263646566676869",
    "1": "00000000000000000000000000000000",
    "2": "00000000000000000000000000000000",
    "3": "FFFFFFFFFFFFFF078069FFFFFFFFFFFF",
}

```
::: info
 0 扇区的 block 0 
:::

### 其他扇区
```json{5}
{
    "60": "00000000000000000000000000000000",
    "61": "00000000000000000000000000000000",
    "62": "00000000000000000000000000000000",
    "63": "FFFFFFFFFFFFFF0780BCFFFFFFFFFFFF"
}
```

## 密码位

## 控制位

<table border="1"><tbody><tr><th>Byte Number</th><td>0</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td></tr><tr><th>Description</th><td colspan="6">KEY A</td><td colspan="4">Access Bits</td><td colspan="6">KEY B (optional)</td></tr><tr><th></th><td colspan="6"></td><td><div id="byte0">0xFF</div></td><td><div id="byte1">0x0F</div></td><td><div id="byte2">0x00</div></td><td>USER</td><td colspan="6"></td></tr></tbody></table>


::: tip
:tada:很棒的在线计算控制位，动态直观 [MIFARE Classic 1K Access Bits Calculator](http://calc.gmss.ru/Mifare1k/)
:::

## 值块

## 鸣谢

* 一款非常优秀的 Mifare 标签读写和分析工具 [MifareClassicTool](https://github.com/ikarus23/MifareClassicTool)
